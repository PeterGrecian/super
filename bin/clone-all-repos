#!/bin/bash
# clone-all-repos - Clone all GitHub repos into the sibling directory (alongside super)
#
# Usage:
#   ./clone-all-repos          # Clone any missing repos
#   ./clone-all-repos --dry-run  # Show what would be cloned without cloning

set -e

# Configuration
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
GRAY='\033[0;37m'
NC='\033[0m'

DRY_RUN=false
if [ "$1" = "--dry-run" ]; then
    DRY_RUN=true
fi

echo -e "${BLUE}Target directory: ${ROOT_DIR}${NC}"
echo ""

# Get all repo names from GitHub
REPOS=$(gh repo list --limit 100 2>/dev/null | awk '{print $1}' | sed 's|^[^/]*/||')

if [ -z "$REPOS" ]; then
    echo "No repos found on GitHub (or gh not authenticated)"
    exit 1
fi

cloned=0
skipped=0

for repo in $REPOS; do
    dest="$ROOT_DIR/$repo"
    if [ -d "$dest" ]; then
        echo -e "${GRAY}⊘${NC} $repo (already exists)"
        skipped=$((skipped + 1))
    else
        if [ "$DRY_RUN" = true ]; then
            echo -e "${YELLOW}⊕${NC} $repo (would clone)"
        else
            echo -e "${GREEN}⊕${NC} $repo (cloning...)"
            gh repo clone "$repo" "$dest" --quiet 2>&1
        fi
        cloned=$((cloned + 1))
    fi
done

echo ""
echo -e "${BLUE}=== Summary ===${NC}"
echo -e "Cloned: ${cloned} | Skipped: ${skipped}"
